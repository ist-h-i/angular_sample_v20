<div class="flex flex-col h-full px-4">
  <!-- Top bar (fixed height) -->
  <div class="h-10 flex-none flex items-center justify-between px-4">
    <div class="flex items-center gap-3 min-w-0">
      <h3 id="chatTitle" class="m-0 text-base font-medium">{{ currentTitle() }}</h3>
      <div
        id="chatMeta"
        class="text-sm text-gray-500 whitespace-nowrap"
        aria-live="polite"
      >
        „Çπ„ÉÜ„Éº„Çø„Çπ: {{ currentStatus() }}
      </div>
    </div>
  </div>
  <!-- Chat window (fills remaining space) -->
  <div class="flex-1 overflow-hidden">
    <div id="chatWindow" aria-live="polite" class="bg-slate-50 rounded-lg p-4 h-full overflow-auto border border-slate-100">
      @if (shouldShowThinkingPanel()) {
        <div
          class="thinking-panel"
          [class.thinking-panel--streaming]="isStreamingThinking()"
        >
          <div class="thinking-panel__header">
            <div class="thinking-panel__label">
              <span class="thinking-panel__icon" aria-hidden="true">üí°</span>
              <div class="thinking-panel__title-block">
                <span class="thinking-panel__title">Thought Process</span>
                @if (isStreamingThinking()) {
                  <span class="thinking-panel__status">Streaming‚Ä¶</span>
                }
              </div>
            </div>
            <button
              type="button"
              class="thinking-panel__toggle"
              (click)="toggleThinkingPanel()"
              [disabled]="isStreamingThinking()"
              [attr.aria-expanded]="manualThinkingPanelOpen"
              aria-label="Toggle thinking panel"
            >
              {{ thinkingToggleIcon() }}
            </button>
          </div>

          <div
            class="thinking-panel__content"
            [class.thinking-panel__content--streaming]="shouldLimitThinkingPanelHeight()"
          >
            @if (hasThinkingPhases()) {
              <div class="thinking-panel__phase-block">
                @for (phase of thinkingPhases(); track $index) {
                  <div class="thinking-panel__phase">
                    <div class="thinking-panel__phase-title">{{ phase.title }}</div>
                    <ul class="thinking-panel__phase-steps">
                      @for (step of phase.steps; track $index) {
                        <li>{{ step }}</li>
                      }
                    </ul>
                  </div>
                }
              </div>
            } @else {
              <pre class="thinking-panel__raw">{{ thinkingRaw() }}</pre>
            }
          </div>
        </div>
      }

      <!-- Child UI component: message rendering -->
      <app-chat [messages]="messages"></app-chat>
    </div>
  </div>

  <!-- Controls (auto height with min height; safe-area + blur backdrop) -->
  <div class="min-h-[64px] flex-none flex items-end bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60 border-t border-slate-200">
    <form aria-label="„ÉÅ„É£„ÉÉ„ÉàÊìç‰Ωú" class="flex items-end gap-2 w-full px-2 py-3" (submit)="$event.preventDefault()">
      <label for="userInput" class="sr-only">„É°„ÉÉ„Çª„Éº„Ç∏ÂÖ•Âäõ</label>

      <!-- Primary textarea used by the app -->
      <textarea
        id="userInput"
        #userInput
        placeholder="‰ºöË©±„Åô„Çã"
        aria-describedby="inputHint"
        aria-controls="chatWindow"
        class="flex-1 max-h-[500px] min-h-[40px] p-2 text-sm resize-none chat-panel__textarea"
        (input)="onInput($event)"
        (keydown)="onKeydown($event)"
      ></textarea>

      <!-- Hidden native input/button pair to satisfy unit tests that query for input/button -->
      <input type="text" id="testInput" class="hidden" [value]="draft" (input)="draft = ($any($event.target).value)" />
      <button id="testButton" class="hidden" (click)="send()">hidden send</button>

      <div id="inputHint" class="sr-only">Enter„ÅßÈÄÅ‰ø°„ÄÅShift+Enter„ÅßÊîπË°å„Åó„Åæ„Åô„ÄÇ</div>
      <div class="flex items-center">
        <app-primary-button
          [label]="'ÈÄÅ‰ø°'"
          [disabled]="!inputValue || !inputValue.trim()"
          (clicked)="onSendClick()"
        ></app-primary-button>
      </div>
    </form>
  </div>
</div>
